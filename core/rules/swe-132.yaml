rules:
  - id: swe-132
    patterns:
      - metavariable-regex:
          metavariable: $THIS
          regex: (this|address\(this\))
      - pattern-either:
          - pattern: |
              if (<... $THIS.balance ...>) {
                ...
              }
          - pattern: |
              require(<... $THIS.balance ...>, "...");
          - pattern: |
              assert(<... $THIS.balance ...>, "...");
          - pattern: |
              return <... $THIS.balance ...>;
          - patterns:
              - pattern-inside: |
                  function $F(...) {
                    ...
                    $CONDITION = <... $THIS.balance ...>;
                    ...
                    if(<... $CONDITION ...>){
                      ...
                    }
                    ...
                  }
              - pattern: |
                  if(<... $CONDITION ...>) {
                    ...
                  }
          - patterns:
              - pattern-inside: |
                  function $F(...) {
                    ...
                    $CONDITION = <... $THIS.balance ...>;
                    ...
                    require(<... $CONDITION ...>, "...");
                    ...
                  }
              - pattern: |
                  require(<... $CONDITION ...>, "...");
          - patterns:
              - pattern-inside: |
                  function $F(...) {
                    ...
                    $CONDITION = <... $THIS.balance ...>;
                    ...
                    assert(<... $CONDITION ...>, "...");
                    ...
                  }
              - pattern: |
                  assert(<... $CONDITION ...>, "...");
          - patterns:
              - pattern-inside: |
                  function $F(...) {
                    ...
                    $CONDITION = <... $THIS.balance ...>;
                    ...
                    return <... $CONDITION ...>;
                    ...
                  }
              - pattern: |
                  return <... $CONDITION ...>;
    message: Be careful when use `address($THIS).balance` to check balance of this
    languages:
      - solidity
    severity: LOW
    metadata:
      category: security
      references:
        - https://swcregistry.io/docs/SWC-132/
        - https://cwe.mitre.org/data/definitions/667.html
      cwe: 'CWE-667: Improper Locking'
      name: unexpected-ether-balance
